# AI Auto Department Transfer Plugin для osTicket

Плагин автоматически переназначает тикеты на соответствующие отделы на основе ключевых слов, найденных в теме, содержимом и прикрепленных файлах. Использует OpenAI для анализа изображений и выбора оптимального отдела при множественных совпадениях.

## Возможности

- **Автоматическая обработка** новых тикетов при создании
- **Ручной запуск** через кнопку в карточке тикета
- **Анализ контента**: тема, тело сообщения, прикрепленные файлы
- **Поддержка форматов файлов**: 
  - Изображения (JPG, JPEG, PNG, GIF, WebP) - через OpenAI Vision API
  - PDF - через pdftotext (если установлен)
  - Word (.doc, .docx) - через antiword или unzip (если установлены)
- **Интеллектуальный выбор** отдела при множественных совпадениях через AI
- **Внутренние заметки** о каждой операции переназначения
- **Гибкая настройка** правил через JSON конфигурацию
- **Логирование** для отладки

## Установка

1. Скопируйте папку `osticket-ai-auto-dept-transfer` в `/include/plugins/`
2. Перейдите в панель администратора: **Admin Panel → Manage → Plugins**
3. Найдите "Auto Department Transfer" и нажмите **Install**
4. После установки нажмите на плагин для настройки

## Настройка

### Основные параметры

1. **OpenAI API Key** - ваш API ключ от OpenAI (обязательно)
   - Получить можно на https://platform.openai.com/api-keys

2. **OpenAI Model** - модель для использования:
   - `gpt-4o` - наиболее мощная, дороже
   - `gpt-4o-mini` - быстрая и доступная (рекомендуется)
   - `gpt-4-turbo` - баланс скорости и качества
   - `gpt-3.5-turbo` - самая дешевая

3. **API Timeout** - максимальное время ожидания ответа (секунды)

4. **Auto-transfer on ticket creation** - автоматически обрабатывать новые тикеты

5. **Max File Size** - максимальный размер файла для обработки (МБ)

6. **Enable Debug Logging** - включить детальное логирование

### Department Transfer Rules

Правила настраиваются через удобный интерфейс динамической таблицы:

1. Нажмите кнопку **"Add Rule"** для добавления нового правила
2. Выберите отдел из выпадающего списка
3. Введите ключевые слова через запятую
4. Повторите для всех необходимых отделов
5. Используйте кнопку **"Remove"** для удаления ненужных правил

**Пример настройки:**

| Department | Keywords |
|-----------|----------|
| Technical Support | password, login, authentication, forgot password |
| Billing | payment, invoice, billing, refund, subscription |
| Bug Reports | bug, error, crash, not working, broken |

**Формат ключевых слов:**
- Разделяются запятыми
- Регистронезависимый поиск
- Частичное совпадение в тексте
- Можно использовать несколько слов для одного отдела

## Использование

### Автоматическая обработка

При включенной опции "Auto-transfer on ticket creation" плагин автоматически:
1. Анализирует каждый новый тикет
2. Извлекает текст из прикрепленных файлов
3. Ищет совпадения с ключевыми словами
4. Переназначает тикет на соответствующий отдел
5. Добавляет внутреннюю заметку с причиной переназначения

### Ручной запуск

В карточке тикета появится кнопка **"Auto Transfer Department"**:
1. Откройте тикет
2. Нажмите кнопку "Auto Transfer Department"
3. Подтвердите действие
4. Плагин выполнит анализ и переназначит тикет при необходимости

![Manual button](docs/images/img.png)


## Логика работы

### Поиск совпадений

1. Плагин собирает весь текст из:
   - Темы тикета
   - Содержимого сообщения
   - Прикрепленных изображений (OCR через AI)
   - PDF файлов (если доступен pdftotext)
   - Word документов (если доступен antiword/unzip)

2. Ищет ключевые слова из настроенных правил

3. При результате:
   - **Нет совпадений** - добавляется заметка "No matching keywords found"
   - **Одно совпадение** - тикет переназначается на этот отдел
   - **Несколько совпадений** - AI выбирает наиболее подходящий отдел

### Внутренние заметки

Каждая операция фиксируется внутренней заметкой:
- Успешное переназначение: указывается целевой отдел и причина
- Отсутствие совпадений: информация о том, что ключевые слова не найдены
- Ошибки: детали проблемы для отладки

## Требования

### Обязательно:
- osTicket 1.14+
- PHP 7.2+
- PHP CURL extension
- OpenAI API ключ

### Опционально (для обработки файлов):
- `pdftotext` - для извлечения текста из PDF
- `antiword` - для Word .doc файлов
- `unzip` - для Word .docx файлов

Без этих утилит изображения будут обрабатываться через OpenAI Vision API, а PDF/Word файлы будут пропускаться.

## Логирование

При включенном "Debug Logging" информация записывается в системный лог:
- Детали обработки каждого тикета
- API запросы и ответы OpenAI
- Найденные совпадения ключевых слов
- Ошибки и исключения

Просмотр логов: зависит от конфигурации сервера (обычно `/var/log/apache2/error.log` или `/var/log/nginx/error.log`)

## Примеры использования

### Техподдержка по уровням

| Department | Keywords |
|-----------|----------|
| Level 1 Support | простой вопрос, как сделать, help, инструкция |
| Level 2 Support | не работает, ошибка, баг, проблема, critical |
| Development | разработка, new feature, enhancement, API |

### По типу запроса

| Department | Keywords |
|-----------|----------|
| Billing | счет, оплата, invoice, payment, billing |
| Refunds | возврат, refund, деньги, compensation |
| Legal | договор, контракт, agreement, юридический |

## Устранение проблем

### Плагин не переназначает тикеты

1. Проверьте, что опция "Auto-transfer on ticket creation" включена
2. Убедитесь, что API ключ OpenAI корректный
3. Проверьте, что правила настроены (выбраны отделы и указаны ключевые слова)
4. Включите Debug Logging и проверьте логи

### Не обрабатываются файлы

1. Проверьте размер файлов (не превышает Max File Size)
2. Для PDF/Word: установите утилиты pdftotext/antiword
3. Для изображений: проверьте, что модель поддерживает Vision API (gpt-4o, gpt-4o-mini)

### Ошибки API

- Проверьте баланс на аккаунте OpenAI
- Увеличьте API Timeout если запросы обрываются
- Проверьте правильность API ключа

## Стоимость использования

OpenAI API платный, примерные цены:
- **GPT-4o-mini**: ~$0.15 за 1M input tokens
- **GPT-4o**: ~$5 за 1M input tokens
- **Vision API**: ~$0.01 за изображение

Рекомендация: используйте gpt-4o-mini для большинства задач.

## Авторы

- Pavel Bahdanau
- Anatoly Melnikov

## Лицензия

Совместимо с лицензией osTicket

